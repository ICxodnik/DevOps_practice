{% extends 'travel_tracker/base.html' %}

{% block title %}–ì–æ–ª–æ–≤–Ω–∞ - –¢—É—Ä–∏—Å—Ç–∏—á–Ω–∏–π —Ç—Ä–µ–∫–µ—Ä{% endblock %}

{% block extra_css %}
<style>
    .stats {
        display: flex;
        gap: 2rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .stat-card {
        flex: 1;
        min-width: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-card h3 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .stat-card p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    #map {
        width: 100%;
        height: 600px;
        border-radius: 10px;
        margin-top: 2rem;
    }
    
    .instructions {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        border-left: 4px solid #667eea;
    }
    
    .instructions h3 {
        margin-bottom: 1rem;
        color: #667eea;
    }
    
    .instructions ul {
        list-style: none;
        padding-left: 0;
    }
    
    .instructions li {
        padding: 0.5rem 0;
        padding-left: 1.5rem;
        position: relative;
    }
    
    .instructions li:before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #667eea;
        font-weight: bold;
    }
    
    .country-tooltip {
        background: rgba(102, 126, 234, 0.9);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        font-weight: 500;
        font-size: 0.9rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    
    .country-tooltip::before {
        border-top-color: rgba(102, 126, 234, 0.9);
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>–í–∞—à—ñ —Ç—É—Ä–∏—Å—Ç–∏—á–Ω—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</h2>
    
    <div class="stats">
        <div class="stat-card">
            <h3>{{ visited_count }}</h3>
            <p>–í—ñ–¥–≤—ñ–¥–∞–Ω–æ –∫—Ä–∞—ó–Ω</p>
        </div>
        <div class="stat-card">
            <h3>{{ total_countries }}</h3>
            <p>–í—Å—å–æ–≥–æ –∫—Ä–∞—ó–Ω</p>
        </div>
        <div class="stat-card">
            <h3>{{ percentage }}%</h3>
            <p>–í—ñ–¥—Å–æ—Ç–æ–∫ –≤—ñ–¥–≤—ñ–¥–∞–Ω–∏—Ö</p>
        </div>
    </div>
    
    <div class="instructions">
        <h3>–Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è:</h3>
        <ul>
            <li>–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫—Ä–∞—ó–Ω—É –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –≤—ñ–¥–º—ñ—Ç–∏—Ç–∏ —ó—ó —è–∫ –≤—ñ–¥–≤—ñ–¥–∞–Ω—É</li>
            <li>–ö–ª—ñ–∫–Ω—ñ—Ç—å –∑–Ω–æ–≤—É, —â–æ–± –ø—Ä–∏–±—Ä–∞—Ç–∏ –≤—ñ–¥–º—ñ—Ç–∫—É</li>
            <li>–í—ñ–¥–≤—ñ–¥–∞–Ω—ñ –∫—Ä–∞—ó–Ω–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –∑–µ–ª–µ–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º</li>
        </ul>
        {% if not is_authenticated %}
        <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
            <strong>üí° –ü—ñ–¥–∫–∞–∑–∫–∞:</strong> –î–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤–∞—à–∏—Ö –≤—ñ–¥–º—ñ—Ç–æ–∫ –º—ñ–∂ —Å–µ—Å—ñ—è–º–∏, –±—É–¥—å –ª–∞—Å–∫–∞, 
            <a href="{% url 'register' %}" style="color: #667eea; font-weight: bold;">–∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—è</a> –∞–±–æ 
            <a href="{% url 'login' %}" style="color: #667eea; font-weight: bold;">—É–≤—ñ–π–¥—ñ—Ç—å</a> —É —Å–∏—Å—Ç–µ–º—É.
        </div>
        {% endif %}
    </div>
    
    <div id="map"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script>
    const countriesData = {{ countries_data|safe }};
    const visitedCount = {{ visited_count }};
    const totalCountries = {{ total_countries }};
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏
    const map = L.map('map').setView([20, 0], 2);
    
    // –î–æ–¥–∞—î–º–æ —Ç–∞–π–ª–∏ –∫–∞—Ä—Ç–∏
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
    const markers = {};
    
    // –î–æ–¥–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏ –¥–ª—è –∫—Ä–∞—ó–Ω
    countriesData.forEach(country => {
        const color = country.visited ? '#28a745' : '#dc3545';
        const icon = L.divIcon({
            className: 'country-marker',
            html: `<div style="
                width: 12px;
                height: 12px;
                background: ${color};
                border: 2px solid white;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                cursor: pointer;
            "></div>`,
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });
        
        const marker = L.marker([country.lat, country.lng], { icon: icon })
            .addTo(map)
            .bindTooltip(country.name, {
                permanent: false,
                direction: 'top',
                offset: [0, -10],
                className: 'country-tooltip'
            })
            .bindPopup(`<b>${country.name}</b><br>${country.visited ? '‚úì –í—ñ–¥–≤—ñ–¥–∞–Ω–æ' : '–ù–µ –≤—ñ–¥–≤—ñ–¥–∞–Ω–æ'}`)
            .on('click', function() {
                toggleCountry(country.id);
            });
        
        markers[country.id] = marker;
    });
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∫—Ä–∞—ó–Ω–∏
    function toggleCountry(countryId) {
        fetch(`/toggle-country/${countryId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            const marker = markers[countryId];
            const country = countriesData.find(c => c.id === countryId);
            
            if (marker && country) {
                // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–ª—ñ—Ä –º–∞—Ä–∫–µ—Ä–∞
                const color = data.visited ? '#28a745' : '#dc3545';
                const newIcon = L.divIcon({
                    className: 'country-marker',
                    html: `<div style="
                        width: 12px;
                        height: 12px;
                        background: ${color};
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                        cursor: pointer;
                    "></div>`,
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });
                marker.setIcon(newIcon);
                marker.setPopupContent(`<b>${country.name}</b><br>${data.visited ? '‚úì –í—ñ–¥–≤—ñ–¥–∞–Ω–æ' : '–ù–µ –≤—ñ–¥–≤—ñ–¥–∞–Ω–æ'}`);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ –≤ –º–∞—Å–∏–≤—ñ
                country.visited = data.visited;
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.querySelectorAll('.stat-card h3')[0].textContent = data.visited_count;
            document.querySelectorAll('.stat-card h3')[2].textContent = data.percentage + '%';
        })
        .catch(error => {
            console.error('–ü–æ–º–∏–ª–∫–∞:', error);
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Å—Ç–∞—Ç—É—Å—É –∫—Ä–∞—ó–Ω–∏');
        });
    }
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}

